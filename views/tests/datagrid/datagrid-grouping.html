
<script>

    var GroupBy = (function() {
        //Can also use in isEquals: function(obj1, obj2)  in datagrid.js
        var equals = function(a, b) {
          return JSON.stringify(a) === JSON.stringify(b);
        };

        var has = function(obj, target) {
          return obj.some(function(value) {
              return equals(value, target);
          });
        };

        //Return just the object properties matching the names
        var pick = function(obj, names) {
          var chosen = {};
          for (var i = 0; i < names.length; i++) {
            chosen[names[i]] = obj[names[i]];
          }
          return chosen;
        };

        //Return the keys
        var keys = function(data, names) {
          return data.reduce(function(memo, item) {
            var key = pick(item, names);

            if (!has(memo, key)) {
              memo.push(key);
            }
            return memo;
          }, []);
        };

        //Looks through each value in the list, returning an array of all the values
        //that contain all of the key-value pairs listed in properties.
        var where = function (data, names) {
          var chosen = [];

          data.map(function(item) {
            var match = true;
            for (prop in names) {
              if (names[prop] !== item[prop]) {
                match = false;
                return;
              }
            }
            chosen.push(item);
            return;
          });

          return chosen;
        };

        //Return a copy of the object without the passed in properties
        var omit = function(data, names) {
          var chosen = {};

          for (prop in data) {
            if (names.indexOf(prop) === -1) {
              chosen[prop] = data[prop];
            }
          }

          return chosen;
        };

        //Grouping Function with Plugins
        var group = function(data, names) {
          var stems = keys(data, names);
          return stems.map(function(stem) {
            return {
              key: stem,
              vals: where(data, stem).map(function(item) {
                return omit(item, names);
              })
            };
          });
        };

        group.register = function(name, converter) {
          return group[name] = function(data, names, extra) {
            var that = this;
            that.extra = extra;
            return group(data, names).map(converter, that);
          };
        };

        return group;
    }());

    GroupBy.register('sum', function(item) {
      var sum = $.extend({}, item.key, {Value: item.vals.reduce(function(memo, node) {
          return memo + Number(node.Value);
      }, 0)});

      return sum;
    });

    GroupBy.register('max', function(item) {
      return $.extend({}, item.key, {Max: item.vals.reduce(function(memo, node) {
          return Math.max(memo, Number(node.Value));
      }, Number.NEGATIVE_INFINITY)});
    });

    GroupBy.register('list', function(item) {
      var extra = this.extra;

      return $.extend({}, item.key, {List: item.vals.map(function(item) {
        return item[extra] + ' (' + item.Value + ')';
      }).join(', ')});
    });

  var data = [
    {Phase: 'Phase 1', Step: 'Step 1', Task: 'Task 1', Value: '5'},
    {Phase: 'Phase 1', Step: 'Step 1', Task: 'Task 2', Value: '10'},
    {Phase: 'Phase 1', Step: 'Step 2', Task: 'Task 1', Value: '15'},
    {Phase: 'Phase 1', Step: 'Step 2', Task: 'Task 2', Value: '20'},
    {Phase: 'Phase 2', Step: 'Step 1', Task: 'Task 1', Value: '25'},
    {Phase: 'Phase 2', Step: 'Step 1', Task: 'Task 2', Value: '30'},
    {Phase: 'Phase 2', Step: 'Step 2', Task: 'Task 1', Value: '35'},
    {Phase: 'Phase 2', Step: 'Step 2', Task: 'Task 2', Value: '40'}
  ];

  console.table(GroupBy.sum(data, ['Phase', 'Step']));
  console.table(GroupBy.list(data, ['Phase'], 'Task'));
  console.table(GroupBy.list(data, ['Phase', 'Step']));
  console.table(GroupBy.max(data, ['Phase']));
  console.table(GroupBy.max(data, ['Phase', 'Step']));
  console.table(GroupBy.list(data, ['Phase']));
  console.table(GroupBy.list(data, ['Phase', 'Step']));
  console.table(GroupBy(data, ['Phase']));
  console.table(GroupBy(data, ['Phase', 'Step']));

</script>
